generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// -------------------------------------------------------------
// CORE BUSINESS MODELS
// -------------------------------------------------------------

model Tenant {
  id        String   @id @default(uuid())
  name      String
  subdomain String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users      User[]
  drivers    Driver[]
  vehicles   Vehicle[]
  invoices   Invoice[]
  orders     Order[]
  complaints Complaint[]

  @@index([subdomain])
}

model User {
  id        String   @id @default(uuid())
  clerkId   String   @unique // Clerk User ID
  email     String   @unique
  role      Role     @default(DRIVER) // CUSTOMER_ADMIN, SUPER_ADMIN, DRIVER
  tenantId  String?
  tenant    Tenant?  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  driver Driver? // Optional Driver profile linked to user

  @@index([tenantId])
}

enum Role {
  SUPER_ADMIN
  CUSTOMER_ADMIN
  DRIVER
}

// -------------------------------------------------------------
// DRIVER & FLEET MANAGEMENT
// -------------------------------------------------------------

model Driver {
  id       String @id @default(uuid())
  userId   String @unique
  user     User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  firstName String
  lastName  String
  phone     String?

  type   DriverType   @default(EMPLOYED) // Angestellt / Selbstständig
  status DriverStatus @default(INACTIVE)

  walletBalance Float @default(0.0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  timeEntries   TimeEntry[]
  ratings       Rating[]
  reports       Report[]
  invoices      Invoice[]
  documents     Document[]
  orders        Order[]
  complaints    Complaint[]
  payouts       Payout[]
  walletHistory WalletHistory[]

  @@index([tenantId])
}

enum DriverType {
  EMPLOYED // Angestellt
  FREELANCE // Selbstständig
  COMMERCIAL // Gewerbetreibend
}

enum DriverStatus {
  ACTIVE
  INACTIVE
  ON_LEAVE
  SICK
}

model Document {
  id       String @id @default(uuid())
  driverId String
  driver   Driver @relation(fields: [driverId], references: [id], onDelete: Cascade)

  type       DocumentType
  title      String
  fileUrl    String
  expiryDate DateTime?
  status     DocumentStatus @default(VALID)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([driverId])
}

enum DocumentType {
  LICENSE // Führerschein
  INSURANCE // Versicherung
  TAX_ID // Steuer-ID
  BUSINESS_REG // Gewerbeanmeldung
  OTHER
}

enum DocumentStatus {
  VALID
  EXPIRED
  WARNING
}

model Vehicle {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  licensePlate    String
  make            String
  model           String
  milage          Int           @default(0)
  nextMaintenance DateTime?
  status          VehicleStatus @default(AVAILABLE)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
}

enum VehicleStatus {
  AVAILABLE
  IN_USE
  MAINTENANCE
  SERVICE
}

// -------------------------------------------------------------
// TRACKING & OPERATIONS
// -------------------------------------------------------------

model TimeEntry {
  id       String @id @default(uuid())
  driverId String
  driver   Driver @relation(fields: [driverId], references: [id], onDelete: Cascade)

  startTime DateTime
  startLat  Float?
  startLng  Float?

  endTime DateTime?
  endLat  Float?
  endLng  Float?

  currentLat Float?
  currentLng Float?

  pauseDuration Int        @default(0) // In Minutes
  status        TimeStatus @default(RUNNING)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([driverId])
}

enum TimeStatus {
  RUNNING
  PAUSED
  COMPLETED
}

model Order {
  id       String  @id @default(uuid())
  tenantId String
  tenant   Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  driverId String?
  driver   Driver? @relation(fields: [driverId], references: [id])

  externalId String? // e.g. Yemeksepeti ID
  source     String  @default("DIRECT") // YEMEKSEPETI, DIRECT, etc.

  customerName  String
  customerPhone String?
  address       String
  notes         String?

  amount Float
  status OrderStatus @default(PENDING)

  // Delivery proof
  deliveryPhoto String?
  deliverySig   String?
  confirmCode   String?

  assignedAt  DateTime?
  deliveredAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([tenantId])
  @@index([driverId])
}

enum OrderStatus {
  PENDING
  ACCEPTED
  PICKED_UP
  ON_THE_WAY
  DELIVERED
  PROBLEMATIC
  CANCELLED
}

model Complaint {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  driverId String
  driver   Driver @relation(fields: [driverId], references: [id], onDelete: Cascade)

  title       String
  description String
  explanation String? // Driver's explanation
  penalty     Int     @default(0) // Point reduction

  status ComplaintStatus @default(OPEN)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([driverId])
}

enum ComplaintStatus {
  OPEN
  RESOLVED
  DISMISSED
}

// -------------------------------------------------------------
// FINANCE & ACCOUNTING
// -------------------------------------------------------------

model Invoice {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  driverId String
  driver   Driver @relation(fields: [driverId], references: [id], onDelete: Cascade)

  invoiceNumber String        @unique
  amount        Float
  taxAmount     Float         @default(0.0)
  period        String?
  status        InvoiceStatus @default(DRAFT)
  dueDate       DateTime?
  fileUrl       String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([driverId])
}

enum InvoiceStatus {
  DRAFT
  PENDING
  ISSUED
  PAID
  OVERDUE
}

model Payout {
  id       String @id @default(uuid())
  driverId String
  driver   Driver @relation(fields: [driverId], references: [id], onDelete: Cascade)

  amount Float
  status PayoutStatus @default(PENDING)
  notes  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([driverId])
}

enum PayoutStatus {
  PENDING
  APPROVED
  PAID
  REJECTED
}

model WalletHistory {
  id       String @id @default(uuid())
  driverId String
  driver   Driver @relation(fields: [driverId], references: [id], onDelete: Cascade)

  amount      Float
  type        WalletType
  description String

  createdAt DateTime @default(now())

  @@index([driverId])
}

enum WalletType {
  EARNING
  BONUS
  PAYOUT
  DEDUCTION
  EXPENSE
}

// -------------------------------------------------------------
// PERFORMANCE & MISC
// -------------------------------------------------------------

model Rating {
  id       String @id @default(uuid())
  driverId String
  driver   Driver @relation(fields: [driverId], references: [id], onDelete: Cascade)

  stars   Int // 1 to 5
  comment String?

  createdAt DateTime @default(now())
}

model Report {
  id       String @id @default(uuid())
  driverId String
  driver   Driver @relation(fields: [driverId], references: [id], onDelete: Cascade)

  type        ReportType
  periodStart DateTime
  periodEnd   DateTime
  fileUrl     String? // Link to generated PDF/Excel

  createdAt DateTime @default(now())
}

enum ReportType {
  WEEKLY
  MONTHLY
}
