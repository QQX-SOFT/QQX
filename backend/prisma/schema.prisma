generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// -------------------------------------------------------------
// CORE BUSINESS MODELS
// -------------------------------------------------------------

model Tenant {
  id         String   @id @default(uuid())
  name       String
  subdomain  String   @unique
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  users      User[]
  drivers    Driver[]
  vehicles   Vehicle[]
  invoices   Invoice[]

  @@index([subdomain])
}

model User {
  id        String   @id @default(uuid())
  clerkId   String   @unique // Clerk User ID
  email     String   @unique
  role      Role     @default(DRIVER) // CUSTOMER_ADMIN, SUPER_ADMIN, DRIVER
  tenantId  String?
  tenant    Tenant?  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  driver    Driver?  // Optional Driver profile linked to user

  @@index([tenantId])
}

enum Role {
  SUPER_ADMIN
  CUSTOMER_ADMIN
  DRIVER
}

// -------------------------------------------------------------
// DRIVER & FLEET MANAGEMENT
// -------------------------------------------------------------

model Driver {
  id        String   @id @default(uuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  firstName String
  lastName  String
  phone     String?
  
  status    DriverStatus @default(INACTIVE)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  timeEntries TimeEntry[]
  ratings     Rating[]
  reports     Report[]
  invoices    Invoice[]

  @@index([tenantId])
}

enum DriverStatus {
  ACTIVE
  INACTIVE
  ON_LEAVE
}

model Vehicle {
  id              String   @id @default(uuid())
  tenantId        String
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  licensePlate    String
  make            String
  model           String
  milage          Int      @default(0)
  nextMaintenance DateTime?
  status          VehicleStatus @default(AVAILABLE)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([tenantId])
}

enum VehicleStatus {
  AVAILABLE
  IN_USE
  MAINTENANCE
}

// -------------------------------------------------------------
// TRACKING & OPERATIONS
// -------------------------------------------------------------

model TimeEntry {
  id            String   @id @default(uuid())
  driverId      String
  driver        Driver   @relation(fields: [driverId], references: [id], onDelete: Cascade)
  
  startTime     DateTime
  startLat      Float?
  startLng      Float?
  
  endTime       DateTime?
  endLat        Float?
  endLng        Float?
  
  pauseDuration Int      @default(0) // In Minutes
  status        TimeStatus @default(RUNNING)

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([driverId])
}

enum TimeStatus {
  RUNNING
  PAUSED
  COMPLETED
}

model Rating {
  id        String   @id @default(uuid())
  driverId  String
  driver     Driver   @relation(fields: [driverId], references: [id], onDelete: Cascade)
  
  stars     Int      // 1 to 5
  comment   String?
  
  createdAt DateTime @default(now())
}

model Report {
  id         String   @id @default(uuid())
  driverId   String
  driver     Driver   @relation(fields: [driverId], references: [id], onDelete: Cascade)
  
  type       ReportType
  periodStart DateTime
  periodEnd   DateTime
  fileUrl    String? // Link to generated PDF/Excel

  createdAt  DateTime @default(now())
}

enum ReportType {
  WEEKLY
  MONTHLY
}

model Invoice {
  id            String   @id @default(uuid())
  tenantId      String
  tenant        Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  driverId      String
  driver        Driver   @relation(fields: [driverId], references: [id], onDelete: Cascade)
  
  invoiceNumber String   @unique
  amount        Float
  period        String?
  status        InvoiceStatus @default(DRAFT)
  dueDate       DateTime?
  fileUrl       String?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([tenantId])
  @@index([driverId])
}

enum InvoiceStatus {
  DRAFT
  PENDING
  ISSUED
  PAID
  OVERDUE
}
